<html>
    <head>
        <script>
            function generateUUID() {
                let a = new Date().getTime();// Timestamp
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
                    let b = Math.random() * 16;// random number between 0 and 16
                    b = (a + b) % 16 | 0;
                    a = Math.floor(a / 16);
                    return (c === "x" ? b : ((b & 0x3) | 0x8)).toString(16);
                });
            }
            const url = "localhost";
            const port = "8080";
            let ws = null;
            let connected = false;
            let connecting = false;
            let returnIdToCallback = {};
            let callQueue = [];
            setInterval(() => {
                if (ws.readyState != ws.OPEN) connected = false;
                if (!connected && !connecting) {
                    //console.log("disconnected");
                    document.body.innerHTML = "<h2>Server disconnected</h2>";
                    
                }
            }, 5000);// 0.5 seconds
            function setup() {
                connecting = true;
                ws = new WebSocket("ws://" + url + ":" + port);
                ws.onclose = () => {
                    console.log("Websocket closed.");
                    connected = false;
                    ws = null;
                    setup();
                }
                ws.onerror = () => {
                    console.log("Websocket error.");
                    if (ws.readyState == ws.OPEN)
                        ws.close();
                }
                ws.onopen = () => {
                    console.clear();
                    console.log("Websocket connected.")
                    connecting = false;
                    connected = true;
                    for (let i = 0; i < callQueue.length; i++) {
                        const [ returnId, cmd ] = callQueue[i];
                        ws.send(JSON.stringify({ type: "call", cmd, returnId }));
                    }
                    ws.onmessage = (messageE) => {
                        const raw = messageE.data;
                        try {
                            const data = JSON.parse(raw);
                            if (data.type == "ping") {
                                ws.send(JSON.stringify({ type: "pong" }));
                                return;
                            } else if (data.type == "return") {
                                if (returnIdToCallback[data.returnId] != undefined)
                                    returnIdToCallback[data.returnId](data.value);
                            } else {
                                console.log(data);
                            }
                        } catch (err) {}
                    };
                }
            }
            setup();
            async function call(cmd) {
                const returnId = generateUUID();
                if (connected)
                    ws.send(JSON.stringify({ type: "call", cmd, returnId }));
                else
                    callQueue.push([ returnId, cmd ]);
                const returnVal = await (new Promise((resolve) => {
                    returnIdToCallback[returnId] = resolve;
                }));
                if (returnVal == "None") return undefined;
                else return JSON.parse(returnVal);
            }
        </script>
        <script>
            async function processDevice(device) {
                if (device.functions != undefined) {
                    for (let i = 0; i < device.functions.length; i++) {
                        const func = device.functions[i];
                        console.log(device.name + "." + func.name + "(" + func.overloads[0].parameters.map((param) => "\"" + param.type + "\"").join(", ") + ")");
                    }
                }
                if (device.values != undefined) {
                    for (let i = 0; i < device.values.length; i++) {
                        const value = device.values[i];
                        console.log(device.name + "." + value.name + " = " + JSON.stringify(value.value));
                        console.log(device.name + "." + value.name + ".get(\"" + value.type + "\")");
                        console.log(device.name + "." + value.name + ".set(\"" + value.type + "\")");
                    }
                }
            }
            call("getDevices()").then((data) => {
                data.forEach(processDevice);
            })
            call("ESP.lights.get()").then((val) => {
                document.getElementById("ESP.lights.value").checked = val;
            })
        </script>
    </head>
    <body>
        <label for="ESP.lights.value">ESP.lights</label>
        <input type="checkbox" name="ESP.lights.value" id="ESP.lights.value" onchange='call("ESP.lights.set(" + (document.getElementById("ESP.lights.value").checked?"true":"false") + ")");'>
    </body>
</html>