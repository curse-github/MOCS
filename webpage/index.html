<html>
    <head>
        <script>
            function generateUUID() {
                let a = new Date().getTime();// Timestamp
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
                    let b = Math.random() * 16;// random number between 0 and 16
                    b = (a + b) % 16 | 0;
                    a = Math.floor(a / 16);
                    return (c === "x" ? b : ((b & 0x3) | 0x8)).toString(16);
                });
            }
            const url = "localhost";
            const port = "8080";
            let ws = null;
            let connected = false;
            let connecting = false;
            let returnIdToCallback = {};
            let callQueue = [];
            let numConnectedDevices = 0;
            function setup() {
                connecting = true;
                ws = new WebSocket("ws://" + url + ":" + port);
                ws.onclose = () => {
                    console.log("Websocket closed.");
                    connected = false;
                    ws = null;
                    containerElement.innerText = "";
                    messageElement.innerText = "MOCS server is not reachable.";
                    numConnectedDevices = 0;
                    setup();
                }
                ws.onerror = () => {
                    console.log("Websocket error.");
                    if (ws.readyState == ws.OPEN)
                        ws.close();
                }
                ws.onopen = () => {
                    //console.clear();
                    console.log("Websocket connected.")
                    connecting = false;
                    connected = true;
                    for (let i = 0; i < callQueue.length; i++) {
                        const [ returnId, cmd ] = callQueue[i];
                        ws.send(JSON.stringify({ type: "call", cmd, returnId }));
                    }
                    messageElement.innerText = "None of your devices are currently connected.";
                    ws.send(JSON.stringify({ type: "subscribe", user: "user", pass: "pass" }));
                    ws.onmessage = (messageE) => {
                        const raw = messageE.data;
                        try {
                            const data = JSON.parse(raw);
                            if (data.type == "ping") {
                                ws.send(JSON.stringify({ type: "pong" }));
                                return;
                            } else if (data.type == "return") {
                                if (returnIdToCallback[data.returnId] != undefined)
                                    returnIdToCallback[data.returnId](data.value);
                                return;
                            } else if (data.type == "connection") {
                                data.devices.forEach((device) => {
                                    numConnectedDevices++
                                    processDevice(addDiv(containerElement, device.name), "", device);
                                });
                                messageElement.innerText = "";
                                return;
                            } else if (data.type == "disconnection") {
                                processDeviceDisconnection(data.name);
                                return;
                            } else {
                                console.log(data);
                                return;
                            }
                        } catch (err) {}
                    };
                }
            }
            let containerElement = undefined;
            let messageElement = undefined;
            document.addEventListener("DOMContentLoaded", async () => {
                containerElement = document.getElementById("container");
                messageElement = document.getElementById("message");
                setup();
            });
            async function call(cmd) {
                const returnId = generateUUID();
                if (connected)
                    ws.send(JSON.stringify({ type: "call", cmd, returnId }));
                else
                    callQueue.push([ returnId, cmd ]);
                const returnVal = await (new Promise((resolve) => {
                    returnIdToCallback[returnId] = resolve;
                }));
                if (returnVal == "None") return undefined;
                else return JSON.parse(returnVal);
            }
        </script>
        <script>
            function addLabel(parent, text, forName) {
                const el = document.createElement("label");
                el.innerText = text;
                el.for = forName;
                parent.appendChild(el);
                return el;
            }
            function addInput(parent, type, nameId, callback) {
                const el = document.createElement("input");
                el.type = type;
                el.name = el.id = nameId;
                if (type == "button") {
                    el.addEventListener("click", (data) => {
                        callback(undefined);
                    });
                } else {
                    el.addEventListener("change", (data) => {
                        callback((type == "checkbox") ? el.checked : el.value);
                    });
                }
                parent.appendChild(el);
                return el;
            }
            function addDiv(parent, id) {
                const el = document.createElement("div");
                el.id = id;
                parent.appendChild(el);
                return el;
            }
            function addBr(parent) {
                const el = document.createElement("br");
                parent.appendChild(el);
                return el;
            }
            function processDevice(parent, parentName, device) {
                if (device.functions != undefined) {
                    device.functions = device.functions.sort((a,b) => a.name.localeCompare(b.name));
                    for (let i = 0; i < device.functions.length; i++) {
                        const func = device.functions[i];
                        for (let j = 0; j < func.overloads.length; j++) {
                            const paramObjs = func.overloads[j].parameters;
                            addLabel(parent, parentName + device.name + "." + func.name + ": ");
                            addInput(parent, "button", parentName + device.name + "." + func.name, () => {
                                let cmd = parentName + device.name + "." + func.name + "(";
                                for (let k = 0; k < paramObjs.length; k++) {
                                    const paramObj = paramObjs[k];
                                    if (k > 0) cmd += ", ";
                                    switch (paramObj.type) {
                                        case "String":
                                            cmd += "\"" + document.getElementById(parentName + device.name + "." + func.name + "." + k).value + "\"";
                                            break;
                                        case "Number":
                                            cmd += document.getElementById(parentName + device.name + "." + func.name + "." + k).value;
                                            break;
                                        case "Bool":
                                            cmd += document.getElementById(parentName + device.name + "." + func.name + "." + k).checked ? "true" : "false";
                                            break;
                                        case "Color":
                                            cmd += "\"" + document.getElementById(parentName + device.name + "." + func.name + "." + k).value.toUpperCase() + "\"";
                                            break;
                                        default:
                                            break;
                                    }
                                }
                                call(cmd + ")")
                            })
                                .value = "Call";
                            for (let k = 0; k < paramObjs.length; k++) {
                                const paramObj = paramObjs[k];
                                let el = undefined;
                                switch (paramObj.type) {
                                    case "String":
                                        el = addInput(parent, "text", parentName + device.name + "." + func.name + "." + k, () => {});
                                        el.value = paramObj.defaultValue;
                                        break;
                                    case "Number":
                                        el = addInput(parent, "number", parentName + device.name + "." + func.name + "." + k, () => {});
                                        el.value = paramObj.defaultValue;
                                        break;
                                    case "Bool":
                                        el = addInput(parent, "checkbox", parentName + device.name + "." + func.name + "." + k, () => {});
                                        el.checked = paramObj.defaultValue;
                                        break;
                                    case "Color":
                                        el = addInput(parent, "color", parentName + device.name + "." + func.name + "." + k, () => {});
                                        el.value = paramObj.defaultValue.toLowerCase();
                                        break;
                                    default:
                                        console.log("unknown param type")
                                        break;
                                }
                            }
                            addBr(parent);
                        }
                        //console.log(device.name + "." + func.name + "(" + func.overloads[0].parameters.map((param) => "\"" + param.type + "\"").join(", ") + ")");
                    }
                }
                if (device.values != undefined) {
                    device.values = device.values.sort((a,b) => a.name.localeCompare(b.name));
                    for (let i = 0; i < device.values.length; i++) {
                        const value = device.values[i];
                        addLabel(parent, parentName + device.name + "." + value.name + ": ");
                        let el = undefined;
                        switch (value.type) {
                            case "String":
                                el = addInput(parent, "text", parentName + device.name + "." + value.name, (data) => {
                                    call(parentName + device.name + "." + value.name + ".set(\"" + data + "\")");
                                });
                                el.value = value.value;
                                break;
                            case "Number":
                                el = addInput(parent, "number", parentName + device.name + "." + value.name, (data) => {
                                    call(parentName + device.name + "." + value.name + ".set(" + data + ")");
                                });
                                el.value = value.value;
                                break;
                            case "Bool":
                                el = addInput(parent, "checkbox", parentName + device.name + "." + value.name, (data) => {
                                    call(parentName + device.name + "." + value.name + ".set(" + (data ? "true" : "false") + ")");
                                });
                                el.checked = value.value;
                                break;
                            case "Color":
                                el = addInput(parent, "color", parentName + device.name + "." + value.name, (data) => {
                                    call(parentName + device.name + "." + value.name + ".set(\"" + data.toUpperCase() + "\")");
                                });
                                el.value = value.value.toLowerCase();
                                break;
                            default:
                                break;
                        }
                        addBr(parent);
                        //console.log(parentName + device.name + "." + value.name + " = " + JSON.stringify(value.value));
                        //console.log(parentName + device.name + "." + value.name + ".get(\"" + value.type + "\")");
                        //console.log(parentName + device.name + "." + value.name + ".set(\"" + value.type + "\")");
                    }
                }
            }
            async function processDeviceDisconnection(name) {
                console.log(name);
                console.log("document.getElementById(\"" + name + "\").remove()");
                document.getElementById(name).remove();
                numConnectedDevices--;
                if (numConnectedDevices == 0) {
                    messageElement.innerText = "None of your devices are currently connected.";
                }
            }
        </script>
    </head>
    <body>
        <div id="message" style="color: red" ></div>
        <div id="container"></div>
    </body>
</html>